<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectroIndex</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border-top-color: #4f46e5; /* indigo-600 */
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        /* Styles for the details view modal */
        .details-section h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            color: #4f46e5; /* text-indigo-600 */
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .details-section p {
            color: #4b5563; /* text-gray-600 */
            white-space: pre-wrap; /* Allows line breaks in textareas to be displayed */
        }
        .details-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 0.5rem;
        }
        .details-grid dt {
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-700 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Navigation Bar -->
    <nav class="bg-indigo-700 p-4 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center space-y-2 md:space-y-0">
            <h1 class="text-3xl font-bold">ElectroIndex</h1>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <button id="home-btn" class="bg-indigo-600 hover:bg-indigo-800 transition-colors duration-200 px-4 py-2 rounded-full font-semibold">Home</button>
                <div id="category-filter-container" class="hidden">
                     <select id="category-filter" class="bg-indigo-600 text-white rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white">
                         <!-- Options will be populated by JavaScript -->
                     </select>
                </div>
                <button id="add-btn" class="bg-indigo-600 hover:bg-indigo-800 transition-colors duration-200 px-4 py-2 rounded-full font-semibold">Add New Part</button>
                <button id="manage-btn" class="bg-indigo-600 hover:bg-indigo-800 transition-colors duration-200 px-4 py-2 rounded-full font-semibold">Manage Parts</button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div id="main-content" class="container mx-auto p-6">
        <!-- Loading Spinner (initially shown) -->
        <div id="loader" class="text-center py-10">
            <div class="spinner border-4 border-t-4 border-gray-200 border-t-indigo-600 rounded-full w-12 h-12 animate-spin mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading Components...</p>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="add-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Add New Part</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-900 text-3xl">&times;</button>
            </div>
            <form id="part-form" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" id="edit-id">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">Title (Name / Model)</label>
                    <input type="text" id="title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2" placeholder="e.g., Microcontrollers, Sensors">
                </div>
                 <div>
                    <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                    <input type="text" id="type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div>
                    <label for="manufacturer" class="block text-sm font-medium text-gray-700">Manufacturer</label>
                    <input type="text" id="manufacturer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700">Short description</label>
                    <textarea id="description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div>
                    <label for="voltage" class="block text-sm font-medium text-gray-700">Operating voltage & power</label>
                    <input type="text" id="voltage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div>
                    <label for="interfaces" class="block text-sm font-medium text-gray-700">Interfaces / I/O</label>
                    <input type="text" id="interfaces" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div>
                    <label for="clock" class="block text-sm font-medium text-gray-700">Clock / Performance</label>
                    <input type="text" id="clock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div>
                    <label for="pins" class="block text-sm font-medium text-gray-700">Pins / Connectors / Form factor</label>
                    <input type="text" id="pins" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="how-it-works" class="block text-sm font-medium text-gray-700">How it works</label>
                    <textarea id="how-it-works" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="needed-to-run" class="block text-sm font-medium text-gray-700">Whatâ€™s needed to run it</label>
                    <textarea id="needed-to-run" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="applications" class="block text-sm font-medium text-gray-700">Typical applications</label>
                    <textarea id="applications" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="specs" class="block text-sm font-medium text-gray-700">Key specs</label>
                    <textarea id="specs" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div>
                    <label for="pros" class="block text-sm font-medium text-gray-700">Pros</label>
                    <textarea id="pros" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div>
                    <label for="cons" class="block text-sm font-medium text-gray-700">Cons</label>
                    <textarea id="cons" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="compatibility" class="block text-sm font-medium text-gray-700">Compatibility / notes</label>
                    <textarea id="compatibility" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="resources" class="block text-sm font-medium text-gray-700">Datasheet & resources (URL)</label>
                    <textarea id="resources" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"></textarea>
                </div>
                <div>
                    <label for="cross-references" class="block text-sm font-medium text-gray-700">Cross-references</label>
                    <input type="text" id="cross-references" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="image-upload" class="block text-sm font-medium text-gray-700">Device Picture</label>
                    <input type="file" id="image-upload" accept="image/*" class="mt-1 block w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
                <div id="image-preview-container" class="col-span-1 md:col-span-2 hidden">
                    <p class="text-sm font-medium text-gray-700">Current Image:</p>
                    <img id="image-preview" src="" alt="Image Preview" class="mt-2 w-full max-h-64 object-contain border rounded-md">
                </div>
                <div class="col-span-1 md:col-span-2 flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-btn" class="px-6 py-2 rounded-full font-semibold btn-secondary text-white">Cancel</button>
                    <button type="submit" id="submit-btn" class="px-6 py-2 rounded-full font-semibold btn-primary text-white">Save Part</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Part Details Modal -->
    <div id="part-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white">
                <h2 id="details-title" class="text-2xl font-bold text-gray-800">Part Details</h2>
                <button id="close-details-modal-btn" class="text-gray-500 hover:text-gray-900 text-3xl">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img id="details-image" src="" alt="Part Image" class="w-full rounded-lg border border-gray-200">
                    </div>
                    <div class="space-y-4">
                        <dl class="details-grid">
                            <dt>Category:</dt>
                            <dd id="details-category"></dd>
                            <dt>Type:</dt>
                            <dd id="details-type"></dd>
                            <dt>Manufacturer:</dt>
                            <dd id="details-manufacturer"></dd>
                        </dl>
                        <div class="details-section">
                            <h3>Description</h3>
                            <p id="details-description"></p>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <h3>Technical Information</h3>
                    <dl class="details-grid">
                        <dt>Voltage/Power:</dt> <dd id="details-voltage"></dd>
                        <dt>Interfaces/IO:</dt> <dd id="details-interfaces"></dd>
                        <dt>Clock/Performance:</dt> <dd id="details-clock"></dd>
                        <dt>Pins/Connectors:</dt> <dd id="details-pins"></dd>
                    </dl>
                </div>

                <div class="details-section">
                    <h3>Usage</h3>
                    <p id="details-how-it-works"></p>
                </div>
                <div class="details-section">
                    <h3>Requirements</h3>
                    <p id="details-needed-to-run"></p>
                </div>
                <div class="details-section">
                    <h3>Applications</h3>
                    <p id="details-applications"></p>
                </div>
                <div class="details-section">
                    <h3>Key Specs</h3>
                    <p id="details-specs"></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="details-section">
                        <h3>Pros</h3>
                        <p id="details-pros"></p>
                    </div>
                    <div class="details-section">
                        <h3>Cons</h3>
                        <p id="details-cons"></p>
                    </div>
                </div>

                <div class="details-section">
                    <h3>Compatibility & Notes</h3>
                    <p id="details-compatibility"></p>
                </div>
                <div class="details-section">
                    <h3>Resources</h3>
                    <p id="details-resources"></p>
                </div>
                <div class="details-section">
                    <h3>Cross-References</h3>
                    <p id="details-cross-references"></p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State ---
            let allParts = [];
            let currentView = 'home'; // 'home' or 'manage'
            const serverUrl = 'http://localhost:3000'; // Your Node.js server address

            // --- UI Elements ---
            const mainContent = document.getElementById('main-content');
            const loader = document.getElementById('loader');
            const addEditModal = document.getElementById('add-edit-modal');
            const detailsModal = document.getElementById('part-details-modal');
            const form = document.getElementById('part-form');
            const categoryFilter = document.getElementById('category-filter');
            const categoryFilterContainer = document.getElementById('category-filter-container');
            
            // --- Image to Base64 Converter ---
            const toBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
            });

            // --- Rendering Logic ---
            function renderCurrentView() {
                if (currentView === 'home') {
                    renderHomeView();
                } else {
                    renderManageView();
                }
            }

            function renderHomeView() {
                mainContent.innerHTML = '';
                categoryFilterContainer.classList.remove('hidden');

                const selectedCategory = categoryFilter.value;
                const partsToDisplay = selectedCategory === 'all' 
                    ? allParts 
                    : allParts.filter(p => p.category === selectedCategory);

                if (partsToDisplay.length === 0) {
                    mainContent.innerHTML = `<p class="text-center text-gray-500 mt-8">No parts found. Try adding one!</p>`;
                    return;
                }

                const groupedByCategory = partsToDisplay.reduce((acc, part) => {
                    (acc[part.category] = acc[part.category] || []).push(part);
                    return acc;
                }, {});

                const sortedCategories = Object.keys(groupedByCategory).sort();

                sortedCategories.forEach(category => {
                    const categorySection = document.createElement('div');
                    categorySection.className = 'mb-12';
                    categorySection.innerHTML = `<h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-2">${category}</h2>`;
                    
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
                    
                    groupedByCategory[category].forEach(part => {
                        grid.innerHTML += createPartCard(part);
                    });

                    categorySection.appendChild(grid);
                    mainContent.appendChild(categorySection);
                });
            }

            function createPartCard(part) {
                const placeholderImg = `https://placehold.co/600x400/e2e8f0/4a5568?text=${encodeURIComponent(part.title)}`;
                const imageSrc = part.imageUrl || placeholderImg;
                // CHANGED: Added part-card class, data-id, and cursor-pointer for details view.
                // CHANGED: Changed object-cover to object-contain to show the full image.
                return `
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300 cursor-pointer part-card" data-id="${part._id}">
                        <div class="h-56 flex items-center justify-center bg-gray-100">
                            <img src="${imageSrc}" alt="${part.title}" class="max-w-full max-h-full object-contain" onerror="this.onerror=null;this.src='${placeholderImg}';">
                        </div>
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-900 truncate">${part.title}</h3>
                            <p class="text-indigo-600 font-semibold">${part.type || ''}</p>
                            <p class="text-gray-600 mt-2 text-sm h-10 overflow-hidden">${part.description || 'No description available.'}</p>
                        </div>
                    </div>
                `;
            }

            function renderManageView() {
                mainContent.innerHTML = '';
                categoryFilterContainer.classList.add('hidden');

                if (allParts.length === 0) {
                    mainContent.innerHTML = `<p class="text-center text-gray-500 mt-8">No parts to manage. Try adding one!</p>`;
                    return;
                }
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'bg-white rounded-lg shadow-lg overflow-x-auto';
                tableContainer.innerHTML = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manufacturer</th>
                                <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${allParts.map(part => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${part.title}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${part.category}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${part.manufacturer}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${part._id}">Edit</button>
                                        <button class="delete-btn text-red-600 hover:text-red-900" data-id="${part._id}">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                mainContent.appendChild(tableContainer);
            }

            function updateCategoryFilter() {
                const categories = [...new Set(allParts.map(p => p.category))].sort();
                categoryFilter.innerHTML = '<option value="all">All Categories</option>';
                categories.forEach(cat => {
                    categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
            }

            // --- Modal & Form Handling ---
            function openAddEditModal(part = null) {
                form.reset();
                document.getElementById('image-preview-container').classList.add('hidden');
                
                if (part) { // Editing existing part
                    document.getElementById('modal-title').innerText = 'Edit Part';
                    document.getElementById('submit-btn').innerText = 'Update Part';
                    document.getElementById('edit-id').value = part._id; // Use MongoDB's _id

                    Object.keys(part).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = part[key];
                    });

                    if (part.imageUrl) {
                        const previewContainer = document.getElementById('image-preview-container');
                        const previewImg = document.getElementById('image-preview');
                        previewImg.src = part.imageUrl;
                        previewContainer.classList.remove('hidden');
                    }
                } else { // Adding new part
                    document.getElementById('modal-title').innerText = 'Add New Part';
                    document.getElementById('submit-btn').innerText = 'Save Part';
                    document.getElementById('edit-id').value = '';
                }
                addEditModal.style.display = 'flex';
            }

            function closeAddEditModal() {
                addEditModal.style.display = 'none';
            }
            
            // NEW: Function to open the details modal
            function openDetailsModal(part) {
                const placeholderImg = `https://placehold.co/600x400/e2e8f0/4a5568?text=${encodeURIComponent(part.title)}`;
                document.getElementById('details-title').textContent = part.title || 'N/A';
                document.getElementById('details-image').src = part.imageUrl || placeholderImg;
                
                // Helper to set text content or a default value
                const setText = (id, value) => {
                    document.getElementById(id).textContent = value || 'N/A';
                };

                setText('details-category', part.category);
                setText('details-type', part.type);
                setText('details-manufacturer', part.manufacturer);
                setText('details-description', part.description);
                setText('details-voltage', part.voltage);
                setText('details-interfaces', part.interfaces);
                setText('details-clock', part.clock);
                setText('details-pins', part.pins);
                setText('details-how-it-works', part['how-it-works']);
                setText('details-needed-to-run', part['needed-to-run']);
                setText('details-applications', part.applications);
                setText('details-specs', part.specs);
                setText('details-pros', part.pros);
                setText('details-cons', part.cons);
                setText('details-compatibility', part.compatibility);
                setText('details-resources', part.resources);
                setText('details-cross-references', part['cross-references']);

                detailsModal.style.display = 'flex';
            }

            // NEW: Function to close the details modal
            function closeDetailsModal() {
                detailsModal.style.display = 'none';
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true;
                submitBtn.innerText = 'Saving...';

                const editId = document.getElementById('edit-id').value;
                const imageFile = document.getElementById('image-upload').files[0];
                let imageUrl = editId ? allParts.find(p => p._id === editId)?.imageUrl : '';

                if (imageFile) {
                    try {
                        imageUrl = await toBase64(imageFile);
                    } catch (error) {
                        console.error("Error converting image to Base64:", error);
                        alert("Could not process the image file.");
                        submitBtn.disabled = false;
                        submitBtn.innerText = 'Save Part';
                        return;
                    }
                }

                const partData = {
                    title: document.getElementById('title').value.trim(),
                    category: document.getElementById('category').value.trim(),
                    type: document.getElementById('type').value.trim(),
                    manufacturer: document.getElementById('manufacturer').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    voltage: document.getElementById('voltage').value.trim(),
                    interfaces: document.getElementById('interfaces').value.trim(),
                    clock: document.getElementById('clock').value.trim(),
                    pins: document.getElementById('pins').value.trim(),
                    'how-it-works': document.getElementById('how-it-works').value.trim(),
                    'needed-to-run': document.getElementById('needed-to-run').value.trim(),
                    applications: document.getElementById('applications').value.trim(),
                    specs: document.getElementById('specs').value.trim(),
                    pros: document.getElementById('pros').value.trim(),
                    cons: document.getElementById('cons').value.trim(),
                    compatibility: document.getElementById('compatibility').value.trim(),
                    resources: document.getElementById('resources').value.trim(),
                    'cross-references': document.getElementById('cross-references').value.trim(),
                    imageUrl: imageUrl || '',
                };
                
                try {
                    let response;
                    if (editId) {
                        response = await fetch(`${serverUrl}/api/parts/${editId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(partData)
                        });
                    } else {
                        response = await fetch(`${serverUrl}/api/parts`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(partData)
                        });
                    }

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    await initializeApp(); 
                    closeAddEditModal();

                } catch (error) {
                    console.error('Failed to save part:', error);
                    alert('Failed to save part. Make sure the server is running.');
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleDelete(partId) {
                if (!confirm('Are you sure you want to delete this part?')) return;
                try {
                    const response = await fetch(`${serverUrl}/api/parts/${partId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    await initializeApp();
                } catch (error) {
                    console.error('Failed to delete part:', error);
                    alert('Failed to delete part. Make sure the server is running.');
                }
            }

            // --- Initial Application Load ---
            async function initializeApp() {
                try {
                    loader.classList.remove('hidden');
                    const response = await fetch(`${serverUrl}/api/parts`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allParts = await response.json();
                    allParts.sort((a, b) => a.title.localeCompare(b.title));
                    updateCategoryFilter();
                    renderCurrentView();
                } catch (error) {
                    console.error('Could not fetch parts from server:', error);
                    mainContent.innerHTML = `<p class="text-center text-red-500 mt-8">Could not connect to the server. Please make sure it's running and try again.</p>`;
                } finally {
                    loader.classList.add('hidden');
                }
            }

            // --- Event Listeners ---
            document.getElementById('add-btn').addEventListener('click', () => openAddEditModal());
            document.getElementById('close-modal-btn').addEventListener('click', closeAddEditModal);
            document.getElementById('cancel-btn').addEventListener('click', closeAddEditModal);
            document.getElementById('close-details-modal-btn').addEventListener('click', closeDetailsModal); // NEW
            form.addEventListener('submit', handleFormSubmit);

            document.getElementById('home-btn').addEventListener('click', () => {
                currentView = 'home';
                renderCurrentView();
            });

            document.getElementById('manage-btn').addEventListener('click', () => {
                currentView = 'manage';
                renderCurrentView();
            });

            categoryFilter.addEventListener('change', renderHomeView);

            // UPDATED: Event delegation to handle clicks for details, edit, and delete
            mainContent.addEventListener('click', (e) => {
                const target = e.target;
                const card = target.closest('.part-card');
                const editBtn = target.closest('.edit-btn');
                const deleteBtn = target.closest('.delete-btn');

                if (card) { // Clicked on a part card to see details
                    const partId = card.dataset.id;
                    const partToShow = allParts.find(p => p._id === partId);
                    if (partToShow) openDetailsModal(partToShow);
                } else if (editBtn) { // Clicked on an edit button
                    const partId = editBtn.dataset.id;
                    const partToEdit = allParts.find(p => p._id === partId);
                    if (partToEdit) openAddEditModal(partToEdit);
                } else if (deleteBtn) { // Clicked on a delete button
                    const partId = deleteBtn.dataset.id;
                    handleDelete(partId);
                }
            });

            // Start the application
            initializeApp();
        });
    </script>
</body>
</html>
